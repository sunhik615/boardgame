<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë³´ë“œê²Œì„ ë°ì´í„° ê´€ë¦¬ì</title>
    <style>
        :root {
            --primary-color: #6c5ce7;
            --secondary-color: #a29bfe;
            --bg-color: #f8f9fa;
            --text-color: #2d3436;
            --white: #ffffff;
            --danger: #ff7675;
            --success: #00b894;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--white);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 30px;
        }

        .alert {
            background: #e1f5fe;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #0277bd;
            border-left: 5px solid #0277bd;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            gap: 10px;
            flex-wrap: wrap;
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
        }

        .search-bar {
            flex: 1;
            min-width: 200px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: #dfe6e9;
            color: #636e72;
        }

        .game-list {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
        }

        .game-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        .game-item:hover {
            background-color: #f1f2f6;
        }

        .game-icon {
            font-size: 24px;
            margin-right: 15px;
            width: 40px;
            text-align: center;
        }

        .game-info {
            flex: 1;
        }

        .game-title {
            font-weight: bold;
            font-size: 16px;
        }

        .game-meta {
            font-size: 12px;
            color: #636e72;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            color: #aaa;
            font-size: 28px;
            border: none;
            cursor: pointer;
            padding: 0;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }

        .form-row>div {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 14px;
            color: #2d3436;
        }

        .helper-text {
            font-size: 12px;
            color: #888;
            margin-top: -5px;
            margin-bottom: 10px;
        }

        .save-area {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px dashed #ddd;
            text-align: center;
        }
    </style>
</head>

<body>

    <div class="container" id="adminContainer" style="display: none;">
        <h1>ğŸ² ë³´ë“œê²Œì„ ë°ì´í„° ê´€ë¦¬ì (v2.0)</h1>

        <script>
            // Simple Password Protection
            (function () {
                const password = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
                if (password === "0320") { // Change this to your desired password
                    document.getElementById('adminContainer').style.display = 'block';
                } else {
                    alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤. ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
                    window.location.href = "index.html";
                }
            })();
        </script>

        <div class="alert">

            <strong>ì‚¬ìš© ë°©ë²•:</strong><br>
            1. ì•„ë˜ ëª©ë¡ì—ì„œ ìˆ˜ì •í•  ê²Œì„ì„ í´ë¦­í•˜ê±°ë‚˜ <strong>'+ ìƒˆ ê²Œì„ ì¶”ê°€'</strong> ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.<br>
            2. ì°½ì´ ëœ¨ë©´ ë‚´ìš©ì„ ìˆ˜ì •í•˜ê³  <strong style="color:var(--primary-color)">'ì €ì¥ (ì„œë²„ ë°˜ì˜)'</strong> ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.<br>
            3. <strong>ì£¼ì˜:</strong> ì €ì¥í•˜ë©´ íŒŒì´ì–´ë² ì´ìŠ¤(ì„œë²„)ì— ì¦‰ì‹œ ë°˜ì˜ë˜ë©°, ì‚­ì œ ì‹œ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
            4. ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ URLì´ ìƒì„±ë˜ì–´ ì…ë ¥ë©ë‹ˆë‹¤.
        </div>

        <div class="toolbar">
            <button class="btn-secondary" onclick="location.href='index.html'">ğŸ  í™ˆìœ¼ë¡œ</button>
            <input type="text" id="searchInput" class="search-bar" placeholder="ê²Œì„ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰...">
            <button class="btn-primary" onclick="window.syncAllRatings()" style="background-color: #f39c12;">ğŸ”„ ë¦¬ë·°
                ë™ê¸°í™”</button>
            <button class="btn-primary" onclick="openModal()">+ ìƒˆ ê²Œì„ ì¶”ê°€</button>
        </div>

        <div class="game-list" id="gameList">
            <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ê²Œì„ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>



        <div class="game-list" id="gameList">
            <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ê²Œì„ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>

        <!-- ë¦¬ë·° ê´€ë¦¬ ëª¨ë‹¬ -->
        <div class="modal" id="reviewModal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2 id="reviewModalTitle">ë¦¬ë·° ê´€ë¦¬</h2>
                    <button class="modal-close" onclick="closeReviewModal()">&times;</button>
                </div>
                <div id="adminReviewList" style="max-height: 60vh; overflow-y: auto;">
                    <p style="text-align: center; color: #666;">ë¡œë”© ì¤‘...</p>
                </div>
                <div style="margin-top: 20px; text-align: right;">
                    <button class="btn-secondary" onclick="closeReviewModal()">ë‹«ê¸°</button>
                </div>
            </div>
        </div>

        <!-- í¸ì§‘ ëª¨ë‹¬ ì°½ -->
        <div class="modal" id="editModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">ê²Œì„ ì •ë³´ ìˆ˜ì •</h2>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>

                <form id="gameForm">
                    <input type="hidden" id="editIndex"> <!-- ë°°ì—´ ì¸ë±ìŠ¤ ì €ì¥ìš© -->

                    <label>ê²Œì„ ì œëª© <span style="color:red">*</span></label>
                    <input type="text" id="title" required placeholder="ì˜ˆ: ìŠ¤í”Œë Œë”">

                    <div class="form-row">
                        <div>
                            <label>ID (ì˜ë¬¸) <span style="color:red">*</span></label>
                            <input type="text" id="id" required placeholder="ì˜ˆ: splendor">
                            <p class="helper-text">ê³ ìœ í•œ ì˜ì–´ ID (ì†Œë¬¸ì, í•˜ì´í”ˆ ê¶Œì¥)</p>
                        </div>
                    </div>

                    <div class="form-row">
                        <div>
                            <label>ì•„ì´ì½˜ (ì´ëª¨ì§€)</label>
                            <input type="text" id="icon" placeholder="ì˜ˆ: ğŸ’">
                        </div>
                        <div>
                            <label>ì¥ë¥´</label>
                            <input type="text" id="genre" placeholder="ì˜ˆ: ì „ëµ, íŒŒí‹°">
                        </div>
                    </div>

                    <div class="form-row">
                        <div>
                            <label>ìµœì†Œ ì¸ì›</label>
                            <input type="number" id="minPlayers" required min="1" value="2">
                        </div>
                        <div>
                            <label>ìµœëŒ€ ì¸ì›</label>
                            <input type="number" id="maxPlayers" required min="1" value="4">
                        </div>
                    </div>

                    <div class="form-row" style="background: #fff9c4; padding: 10px; border-radius: 8px;">
                        <div style="flex: 2;">
                            <label style="color: #f39c12;">â˜… ì¶”ì²œ ì¸ì› (ë² ìŠ¤íŠ¸)</label>
                            <input type="number" id="bestPlayers" placeholder="ì„ íƒì‚¬í•­ (ì˜ˆ: 4)">
                            <p class="helper-text">ë¹„ì–´ë‘ë©´ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>

                    <div class="form-row">
                        <div>
                            <label>í”Œë ˆì´ ì‹œê°„</label>
                            <input type="text" id="playTime" placeholder="ì˜ˆ: 30ë¶„">
                        </div>
                        <div>
                            <label>ë‚œì´ë„ (1.0 ~ 5.0)</label>
                            <input type="number" step="0.01" id="difficulty" placeholder="ì˜ˆ: 2.5">
                        </div>
                    </div>

                    <label>ë©”ì»¤ë‹ˆì¦˜ (ì½¤ë§ˆë¡œ êµ¬ë¶„)</label>
                    <input type="text" id="mechanism" placeholder="ì˜ˆ: ì…‹ ì»¬ë ‰ì…˜, ë“œë˜í”„íŠ¸">

                    <label>ì„¤ëª…</label>
                    <textarea id="description" rows="3" placeholder="ê²Œì„ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…ì„ ì ì–´ì£¼ì„¸ìš”."></textarea>

                    <div style="background: #f1f2f6; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <label>ğŸ–¼ï¸ ì´ë¯¸ì§€ ì„¤ì •</label>

                        <label style="font-size: 13px; margin-top: 10px;">1. ëŒ€í‘œ ì´ë¯¸ì§€ (ì¹´ë“œ/ë°°ê²½ìš©)</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="mainImage" placeholder="ì˜ˆ: splendor.jpg or URL" style="flex:1;">
                            <input type="file" id="mainImageFile" accept="image/*" style="display:none;"
                                onchange="handleFileUpload('mainImage', this.files[0])">
                            <button type="button" class="btn-secondary"
                                onclick="document.getElementById('mainImageFile').click()">ğŸ“¤ ì—…ë¡œë“œ</button>
                        </div>

                        <label style="font-size: 13px; margin-top: 10px;">2. ì¶”ê°€ ìƒì„¸ ì´ë¯¸ì§€ (ìƒì„¸í˜ì´ì§€ ê°¤ëŸ¬ë¦¬ìš©)</label>
                        <textarea id="detailImages" rows="2"
                            placeholder="ì˜ˆ: splendor_play.jpg, splendor_components.jpg (ì‰¼í‘œë¡œ êµ¬ë¶„)"></textarea>
                        <p class="helper-text">'assets/images/games/' í´ë”ì— ìˆëŠ” íŒŒì¼ëª…ì„ ì…ë ¥í•˜ê±°ë‚˜, ìœ„ ì—…ë¡œë“œ ë²„íŠ¼ìœ¼ë¡œ URLì„ ìƒì„±í•´ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</p>
                    </div>

                    <label>í™•ì¥íŒ© ì •ë³´ (ì„ íƒì‚¬í•­)</label>
                    <input type="text" id="expansion" placeholder="ë³´ìœ  ì¤‘ì¸ í™•ì¥íŒ©ì´ ìˆë‹¤ë©´ ì…ë ¥í•˜ì„¸ìš”.">

                    <div
                        style="margin-top: 20px; display: flex; justify-content: space-between; padding-top: 15px; border-top: 1px solid #eee;">
                        <button type="button" class="btn-danger" id="deleteBtn" onclick="deleteGame()">ì‚­ì œí•˜ê¸°</button>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                        </div>
                        <button type="button" class="btn-primary" onclick="saveGame()">ì €ì¥ (ì„œë²„ ë°˜ì˜)</button>
                    </div>
            </div>
            </form>
        </div>
    </div>
    </div>

    <!-- Firebase Config & Scripts -->
    <script type="module">
        import { db, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, getDoc, storage, ref, uploadBytes, getDownloadURL, query, where, orderBy } from "./firebase-config.js";

        let currentGameList = [];
        const gameListEl = document.getElementById('gameList');
        const searchInput = document.getElementById('searchInput');
        const editModal = document.getElementById('editModal');
        const gameForm = document.getElementById('gameForm');

        // Firestore References
        const gamesCollection = collection(db, "games");

        // Load Games from Firestore
        async function loadGames() {
            gameListEl.innerHTML = '<div style="padding:20px; text-align:center;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            try {
                const snapshot = await getDocs(gamesCollection);
                currentGameList = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.docId = doc.id; // Store Firestore Document ID
                    // If 'id' field is missing, use doc.id
                    if (!data.id) data.id = doc.id;
                    currentGameList.push(data);
                });
                renderList(searchInput.value);
            } catch (error) {
                console.error("Error loading games:", error);
                gameListEl.innerHTML = `<div style="padding:20px; text-align:center; color:red;">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${error.message}</div>`;
            }
        }

        // Initial Load
        loadGames();

        // Search Listener
        searchInput.addEventListener('input', (e) => {
            renderList(e.target.value.toLowerCase());
        });

        function renderList(keyword = '') {
            gameListEl.innerHTML = '';
            if (currentGameList.length === 0) {
                gameListEl.innerHTML = '<div style="padding:20px; text-align:center;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            currentGameList.forEach((game) => {
                if (keyword && !game.title.toLowerCase().includes(keyword) && !game.id.toLowerCase().includes(keyword)) {
                    return;
                }

                const item = document.createElement('div');
                item.className = 'game-item';
                item.onclick = () => openModal(game.docId);

                let bestBadge = '';
                if (game.bestPlayers) {
                    bestBadge = `<span style="background:#fff9c4; color:#f39c12; padding:2px 5px; border-radius:4px; font-size:11px; margin-left:5px;">â˜…${game.bestPlayers}ì¸ ì¶”ì²œ</span>`;
                }

                item.innerHTML = `
            <div class="game-icon">${game.icon || 'ğŸ²'}</div>
            <div class="game-info">
                <div class="game-title">${game.title} ${bestBadge} <span style="font-weight:normal; font-size:12px; color:#888;">(${game.id})</span></div>
                <div class="game-meta">${game.minPlayers}-${game.maxPlayers}ì¸ | ${game.playTime || '-'} | ë‚œì´ë„ ${game.difficulty || '-'}</div>
            </div>
            <div>
                <button class="btn-secondary" onclick="event.stopPropagation(); openReviewModal('${game.id}', '${game.title}')" style="font-size: 0.8rem; padding: 5px 10px; margin-right: 5px;">ğŸ’¬ ë¦¬ë·° ê´€ë¦¬</button>
            </div>
            `;
                gameListEl.appendChild(item);
            });
        }

        // Expose function to window for file upload handling
        window.handleFileUpload = async function (targetInputId, file) {
            if (!file) return;

            const uploadBtn = document.querySelector(`button[onclick*="'${targetInputId}'"]`);
            const originalText = uploadBtn.innerText;
            uploadBtn.innerText = "â³ ì—…ë¡œë“œ ì¤‘...";
            uploadBtn.disabled = true;

            try {
                // Upload to Firebase Storage
                // Path: games/{filename}
                const storageRef = ref(storage, 'games/' + file.name);
                await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(storageRef);

                // Set URL to input field
                document.getElementById(targetInputId).value = downloadURL;
                alert('ì—…ë¡œë“œ ì„±ê³µ!');
            } catch (error) {
                console.error("Upload failed:", error);
                alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
            } finally {
                uploadBtn.innerText = originalText;
                uploadBtn.disabled = false;
                // Reset file input to allow re-uploading same file if needed
                document.getElementById(targetInputId + 'File').value = '';
            }
        };

        window.openModal = function (docId = null) {
            editModal.classList.add('active');
            document.getElementById('editIndex').value = docId || ''; // Using docId instead of index

            const deleteBtn = document.getElementById('deleteBtn');
            const modalTitle = document.getElementById('modalTitle');
            const form = document.getElementById('gameForm');

            form.reset();

            if (docId) {
                deleteBtn.style.display = 'block';
                modalTitle.innerText = 'ê²Œì„ ì •ë³´ ìˆ˜ì •';

                const game = currentGameList.find(g => g.docId === docId);
                if (game) {
                    document.getElementById('title').value = game.title || '';
                    document.getElementById('id').value = game.id || '';
                    document.getElementById('icon').value = game.icon || '';
                    document.getElementById('genre').value = game.genre || '';
                    document.getElementById('mechanism').value = game.mechanism || '';
                    document.getElementById('minPlayers').value = game.minPlayers || '';
                    document.getElementById('maxPlayers').value = game.maxPlayers || '';
                    document.getElementById('bestPlayers').value = game.bestPlayers || '';
                    document.getElementById('playTime').value = game.playTime || '';
                    document.getElementById('difficulty').value = game.difficulty || '';
                    document.getElementById('description').value = game.description || '';
                    document.getElementById('expansion').value = game.expansion || '';

                    if (game.images && Array.isArray(game.images) && game.images.length > 0) {
                        document.getElementById('mainImage').value = game.images[0];
                        if (game.images.length > 1) {
                            document.getElementById('detailImages').value = game.images.slice(1).join(', ');
                        }
                    } else if (game.image) {
                        document.getElementById('mainImage').value = game.image;
                    }
                }
            } else {
                deleteBtn.style.display = 'none';
                modalTitle.innerText = 'ìƒˆ ê²Œì„ ì¶”ê°€';
                document.getElementById('minPlayers').value = 2;
                document.getElementById('maxPlayers').value = 4;
            }
        };

        window.closeModal = function () {
            editModal.classList.remove('active');
        };

        window.saveGame = async function () {
            const docId = document.getElementById('editIndex').value;
            const isNew = !docId;

            const title = document.getElementById('title').value.trim();
            const id = document.getElementById('id').value.trim();

            if (!title || !id) {
                alert('ì œëª©ê³¼ IDëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
                return;
            }

            const formData = {
                id: id,
                title: title,
                genre: document.getElementById('genre').value.trim(),
                mechanism: document.getElementById('mechanism').value.trim(),
                minPlayers: parseInt(document.getElementById('minPlayers').value) || 1,
                maxPlayers: parseInt(document.getElementById('maxPlayers').value) || 1,
                playTime: document.getElementById('playTime').value.trim(),
                difficulty: parseFloat(document.getElementById('difficulty').value) || 1,
                icon: document.getElementById('icon').value.trim(),
                description: document.getElementById('description').value.trim(),
            };

            // Check for imageClass (legacy support or new convention)
            // If new, we can default it to ID or omit. Let's omit and rely on ID logic in app.js

            const bestPlayersInput = document.getElementById('bestPlayers').value;
            if (bestPlayersInput) formData.bestPlayers = parseInt(bestPlayersInput);

            const expansionInput = document.getElementById('expansion').value.trim();
            if (expansionInput) formData.expansion = expansionInput;

            const mainImg = document.getElementById('mainImage').value.trim();
            const detailImgsStr = document.getElementById('detailImages').value.trim();
            const newImages = [];
            if (mainImg) newImages.push(mainImg);
            if (detailImgsStr) newImages.push(...detailImgsStr.split(',').map(s => s.trim()).filter(s => s));

            if (newImages.length > 0) formData.images = newImages;

            try {
                if (isNew) {
                    await addDoc(gamesCollection, formData);
                    alert('ìƒˆ ê²Œì„ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                } else {
                    const gameRef = doc(db, "games", docId);
                    await updateDoc(gameRef, formData);
                    alert('ê²Œì„ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }
                closeModal();
                loadGames(); // Reload list
            } catch (error) {
                console.error("Error saving best players:", error);
                alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        async function syncAllRatings() {
            if (!confirm('ëª¨ë“  ê²Œì„ì˜ í‰ì  ì •ë³´ë¥¼ ê°±ì‹ í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì‹œê°„ì´ ì¡°ê¸ˆ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)')) return;

            try {
                // Determine source for games list
                // If window.games is populated, use it. Otherwise fetch.
                let gamesToSync = window.games || currentGameList;

                if (!gamesToSync || gamesToSync.length === 0) {
                    const q = query(collection(db, "games"), orderBy("title"));
                    const querySnapshot = await getDocs(q);
                    gamesToSync = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        data.id = doc.id;
                        gamesToSync.push(data);
                    });
                }

                let count = 0;
                for (const game of gamesToSync) {
                    // Call the shared update logic exposed in app.js
                    // Note: We need to ensure app.js functions are available or replicate logic here.
                    // Since app.js is a module in admin.html context? No, admin.html imports firebase-config directly.
                    // app.js is NOT imported in admin.html usually. We should replicate or import logic.
                    // Replicating logic here for safety in admin context.

                    const qReviews = query(collection(db, "reviews"), where("gameId", "==", game.id));
                    const snapshot = await getDocs(qReviews);
                    let totalRating = 0;
                    let reviewCount = 0;

                    snapshot.forEach(d => {
                        const r = d.data();
                        totalRating += Number(r.rating);
                        reviewCount++;
                    });

                    const average = reviewCount > 0 ? Number((totalRating / reviewCount).toFixed(1)) : 0;

                    try {
                        await updateDoc(doc(db, "games", game.id), {
                            averageRating: average,
                            reviewCount: reviewCount
                        });
                        count++;
                        console.log(`Synced ${game.title} (ID: ${game.id}): Avg ${average}, Count ${reviewCount}`);
                    } catch (err) {
                        if (err.code === 'not-found') {
                            console.warn(`Skipping ${game.title} (ID: ${game.id}): Document not found in DB. Make sure the ID in 'games' collection matches.`);
                        } else {
                            console.error(`Error syncing ${game.title}:`, err);
                        }
                    }
                }

                alert(`${count}ê°œ ê²Œì„ì˜ í‰ì  ë™ê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`);
                location.reload();

            } catch (e) {
                console.error(e);
                alert('ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        window.syncAllRatings = syncAllRatings;

        window.deleteGame = async function () {
            const docId = document.getElementById('editIndex').value;
            if (docId && confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì„œë²„ì—ì„œ ì¦‰ì‹œ ì‚­ì œë©ë‹ˆë‹¤)')) {
                try {
                    await deleteDoc(doc(db, "games", docId));
                    alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    closeModal();
                    loadGames();
                } catch (e) {
                    console.error("Error deleting game: ", e);
                    alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + e.message);
                }
            }
        };

        // Review Management Logic
        const reviewModal = document.getElementById('reviewModal');
        const reviewListEl = document.getElementById('adminReviewList');
        const reviewModalTitle = document.getElementById('reviewModalTitle');

        window.openReviewModal = async (gameId, gameTitle) => {
            reviewModal.style.display = 'flex';
            reviewModalTitle.textContent = `'${gameTitle}' ë¦¬ë·° ê´€ë¦¬`;
            reviewListEl.innerHTML = '<p style="text-align: center; padding: 20px;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';

            try {
                const q = query(collection(db, "reviews"), where("gameId", "==", gameId), orderBy("timestamp", "desc"));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    reviewListEl.innerHTML = '<p style="text-align: center; padding: 20px; color: #999;">ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                reviewListEl.innerHTML = '';
                snapshot.forEach(doc => {
                    const review = doc.data();
                    const date = new Date(review.timestamp?.toDate ? review.timestamp.toDate() : review.timestamp).toLocaleDateString();

                    const item = document.createElement('div');
                    item.style.borderBottom = '1px solid #eee';
                    item.style.padding = '15px';
                    item.style.display = 'flex';
                    item.style.justifyContent = 'space-between';
                    item.style.alignItems = 'flex-start';

                    item.innerHTML = `
            <div style="flex: 1;">
                <div style="font-weight: bold; margin-bottom: 5px;">
                    ${escapeHtml(review.nickname)}
                    <span style="color: #f1c40f;">${'â˜…'.repeat(review.rating) + 'â˜†'.repeat(10 - review.rating)}</span>
                    <span style="font-size: 12px; color: #999; margin-left: 10px;">${date}</span>
                </div>
                <div style="color: #444; font-size: 14px;">${escapeHtml(review.comment)}</div>
            </div>
            <button class="btn-danger" style="font-size: 12px; padding: 5px 10px;" onclick="deleteReviewAdmin('${doc.id}', '${gameId}', '${gameTitle}')">ì‚­ì œ</button>
                    `;
                    reviewListEl.appendChild(item);
                });
            } catch (error) {
                console.error("Error loading reviews:", error);
                reviewListEl.innerHTML = '<p style="text-align: center; color: red;">ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
            }
        };

        window.closeReviewModal = () => {
            reviewModal.style.display = 'none';
        };

        window.deleteReviewAdmin = async (reviewId, gameId, gameTitle) => {
            if (!confirm('ê²½ê³ : ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì´ ë¦¬ë·°ë¥¼ ì¦‰ì‹œ ì‚­ì œí•©ë‹ˆë‹¤. ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                await deleteDoc(doc(db, "reviews", reviewId));
                // Reload list
                openReviewModal(gameId, gameTitle);
            } catch (error) {
                console.error("Error deleting review:", error);
                alert("ì‚­ì œ ì‹¤íŒ¨: " + error.message);
            }
        };

        // Helper
        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            if (event.target == editModal) {
                closeModal();
            }
            if (event.target == reviewModal) {
                closeReviewModal();
            }
        }
    </script>

</body>

</html>